{"version":3,"sources":["../../src/index.js"],"names":["app","set","process","env","PORT","use","static","__dirname","get","request","response","render","listen","console","log","Promise","require","size","promisify","fbinit","initializeApp","serviceAccount","databaseURL","oauthData","client_id","client_secret","access_token","refresh_token","redirect_uri","expires_at","code","allupdates","dB","database","ref","on","snapshot","val","JSON","stringify","errorObject","checkStatus","statusCode","refreshAuth","error","Error","statusText","saveOauthData","od","update","handleCallback","req","res","hascode","agentId","query","headers","options","uri","method","body","grant_type","json","then","pb","send","catch","err","oauthHeaders","promiseSaveListings","listings","finishUpdate","uplst","ups","o","e","p","zippath","citypath","streetpath","streetnumpath","push","Object","assign","updates","resolve","reject","setTimeout","minipromise","prom","obj","forEach","uplist","media","listing","StandardFields","Photos","UriThumb","UriLarge","Uri800","Uri300","Uri1024","Id","Caption","idpath","entry","entrygeo","paths","saving","keys","url","key","dimensions","length","width","g","end","message","removeall","remit","remove","getPage","ops","getListings","filter","addr","combo","pageops","setargs","_filter","opsurl","makeUrl","authops","pages","currentpage","pagearr","page","pageReq","newops","promisedPages","map","all","StatusCodeError","reason","RequestError","cause","args","zipcode","proptype","base","status","argfilter","select","andT","zipfilter","andZ","proptypefilter","andP","statusFilter","formatargs","_orderby","_limit","_select","arr","argEntry","join","promiseTo","doThis","oa","rauth","params","thefilter","location"],"mappings":"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","file":"index.js","sourcesContent":["import express from \"express\";\nimport fb from 'firebase'\nimport rp from 'request-promise';\nlet app = express();\n\napp.set('port', (process.env.PORT || 5000));\n\napp.use(express.static(__dirname + '/public'));\n\n// views is directory for all template files\napp.set('views', __dirname + '/views');\napp.set('view engine', 'ejs');\n\napp.get('/', function(request, response) {\n    response.render('pages/index');\n});\n\napp.listen(app.get('port'), function() {\n    console.log('Node app is running on port', app.get('port'));\n});\n\n//import path from 'path';\n\n//let server = require('https').Server(app);\nconst Promise = require('bluebird'),\n    size = Promise.promisify(require('request-image-size'));\nimport {\n    encode,\n    decode,\n    encodeComponents,\n    decodeComponents,\n} from 'firebase-encode';\nimport fetch from 'node-fetch'\nimport errors from 'request-promise/errors';\nlet fbinit = fb.initializeApp({\n    serviceAccount: {\n        \"type\": \"service_account\",\n        \"project_id\": \"sparkidxapi\",\n        \"private_key_id\": \"81085b6ba0707d1c02831f6b4b0b03a389f134dc\",\n        \"private_key\": \"-----BEGIN PRIVATE KEY-----\\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDgM1W+jsFYFGca\\n7TbB6mquembWVNI5BHXR0rO9ApMmLzfvW435Fh3ONjVFf1xkHOk8LpFpSKtzlKow\\ndxqZmeAJCRGRmqA0Tu3KGy2BvWmzkU+COezS8oLEcgSW7OJUsToxLwp3nvjKSBF8\\n50Vzsvu3WvlUzEmUkEB6InKBvgfhXAAi/YTRW6yhsIE+SZZ5lkhmEPaNALqWtJCx\\ni5Qw07Oz7OgeM0duJFMX3vL++y+SWkS5RM1u2KSrmQFPxD5tefutyIGM8JNeHABY\\n0FV5OtYulL8rspo6fqtI9kOuLXaNPYfWi7My4LsEbdX62iw2qOzdz62LIp5Op2gD\\nEFbJfmQxAgMBAAECggEBAJZQdKVtCp3mF/aKohLC+sF+GSKL/eHyZpfFv3HynvuT\\n3tmgtYAR3uvZlj/BEw2gAJOz2RQQf7rfKneR8wiWjQkhxmCrnctUO8MsE4ePmaWl\\nv/vcoDYSF7BjjUYvDdOgexZspoTq1XyxcuAeIodesbsNyGqdCJwNVt1L6R+pa5kg\\nF0eMozszPQXGeMfDFpjhpwXBcq67bFXdk4SqlvDeNSHxjWfl7/Hr0Kr8v0JnoJcw\\nuPxwLi6mvHVpYSVqpseQkr8aZ6xypT1+2ztkivMmqooRXFUaclxxIO2K1xCmncQg\\neGabGBOPzw2Zh/UnCnDfDYeaZ5k4pKNqfjBQM6o3il0CgYEA8iVXXfMjCVcdC/xq\\nrOAPir6jXy4u3f2ZSxMmDHgG6IFCxCPwhvjCE3Uv84Wnr6HZ114gSMGFIq9ZS22U\\nt7Uejq7UELVVn4pDAzPhdlJU9mBwTBcdoB1bJx1KtfCt8b9+M30H5JaMPJ+x22Z7\\nyWxhwMPu0N3TGuy2Z8Ue0zKvsLMCgYEA7Qcm8sm+uliCcS7ypNmbn2nRiEp9yFan\\nGZUb4flKO6xHJ/vBj60UEYKYkL63syXDdQ6yAV8jZlJHxVGIT7yJ0AhVkNo/oK4f\\nPNXiO4dw+N8ReJhcjwKmU0dOMK4rzH9QGma4WaIO1NXXhap2PbBlF/Yy4IlBnNHW\\n+7Faf1zUQYsCgYEAsHTBu/cIWzAePLPO0Pfem47c4ul2wdKiOPFVUtTMw/YeP2yp\\nRNJWK3PEY8PMNNLPOoCfKiXL7UC2456RN2ZHRFbmtt5N7RsGRnkyHdVVkM0qSGi3\\n8Aw0dsaDwR4IxBh10POWIuAKhcsiAu4l2tyeR6kAiTh9NCu3qNse4W0YVr0CgYBt\\njqS+C+oQj+CbGCwnbj20TWEAMg45j3PlKzqcFHHvaw3ouUEae9GO1mJWZRDbyVSy\\nwnwcjjD6loV9+tWapXa9pVyHe5l1V4YwxFuxUEUzg0e8ChCeOYdPbuIBNkAgYahQ\\ny7HiHDnmvoDD06qbkPDpRm71wfuF1Kgd5jgCLpIdSQKBgQCezHrV+ZHOvoxljR+x\\n3/kpwfHyWrqIbETvUz2TbjMc52igcdr09hbsp4mNTl0uy6kMk1MMHVCKNgWdS48x\\n6crGgSU/sIugJ9U3Ph7SWEf4wjPYgFRbB8dcbK/+M7SvCJ2/NR8UZKWXxa5TpO4+\\n2ElOQBtoUlLTnACetImf5YcchA==\\n-----END PRIVATE KEY-----\\n\",\n        \"client_email\": \"apiauth@sparkidxapi.iam.gserviceaccount.com\",\n        \"client_id\": \"113743275477969379982\",\n        \"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\",\n        \"token_uri\": \"https://accounts.google.com/o/oauth2/token\",\n        \"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\",\n        \"client_x509_cert_url\": \"https://www.googleapis.com/robot/v1/metadata/x509/apiauth%40sparkidxapi.iam.gserviceaccount.com\"\n    },\n    databaseURL: \"https://sparkidxapi.firebaseio.com\"\n});\n\nlet oauthData = {\n    client_id: ' ',\n    client_secret: '',\n    access_token: '',\n    refresh_token: '',\n    redirect_uri: '',\n    expires_at: '',\n    code:''\n}\nlet allupdates=[]\nlet dB = fb.database();\nfbinit.database().ref('/sparkauth/oauth').on(\"value\", function(snapshot) {\n    oauthData.client_id= snapshot.val().client_id\n    oauthData.client_secret= snapshot.val().client_secret\n    oauthData.access_token= snapshot.val().access_token\n    oauthData.refresh_token= snapshot.val().refresh_token\n    oauthData.redirect_uri= snapshot.val().redirect_uri\n    oauthData.expires_at= snapshot.val().expires_at?snapshot.val().expires_at:\"0\"\n    oauthData.code = snapshot.val().code\n    console.log(\"auth updated!\"+JSON.stringify(oauthData));\n\n}, function (errorObject) {\n    console.log(\"The read failed: \" + errorObject.code);\n});\n\nfunction checkStatus(response){\n    if (response.statusCode == 401) {\n        console.log('response = 401 ? '+response.statusCode)\n        // let oauthData = Object.assign({},oauthData)\n        // let fBdB = this.fBdB\n        return refreshAuth(oauthData);\n    }\n    if (response.statusCode >= 200 && response.statusCode < 300) {\n        return response\n    } else {\n        let error = new Error(response.statusText)\n        error.response = response\n        console.log('got error while checking status '+error);\n    }\n}\nfunction saveOauthData(od) {\n    console.log(\"saving OauthData ->\"+od);\n    return dB.ref('/sparkauth/oauth').update(od)\n}\nfunction handleCallback(req, res) {\n    let code = ''\n    let hascode = false;\n    let agentId = '';\n    if (req.query['openid.spark.code']) {\n        code = req.query['openid.spark.code'];\n        hascode=true;\n    }\n    if (req.query['openid_spark_code']) {\n        code = req.query['openid_spark_code'];\n        hascode=true;\n    }\n    if (req.query['code']){\n        code = req.query['code'];\n        hascode=true;\n    }\n\n    if (req.query['openid.spark.state']) {\n        agentId = req.query['openid.spark.state']\n    }\n    if(req.query['state']) {\n        agentId = req.query['state']\n    }\n    // console.log(req.query['openid.spark.code'] + ' : from callback');\n    let headers = {\n        'X-SparkApi-User-Agent': 'Idx Agent',\n        'Content-Type': 'application/json'\n    };\n    let options;\n    options = {\n        uri: 'https://sparkapi.com/v1/oauth2/grant',\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify({\n            client_id: oauthData.client_id,\n            client_secret: oauthData.client_secret,\n            grant_type: \"authorization_code\",\n            code: hascode ? code : oauthData.code,\n            redirect_uri: oauthData.redirect_uri\n        }),\n        json:true\n    };\n    rp(options)\n        .then(pb=>{\n            saveOauthData(pb)\n            res.send('<strong>zip codes</strong><br><a href=\"/zip/07717\"><br/><strong>zip 07717</strong><br><a href=\"/zip/08736\"><strong>zip 08736</strong><br/><br/><strong>Log in</strong> with Spark</a>' +\n                '<a href=\"https://sparkplatform.com/oauth2?response_type=code&client_id='+oauthData.client_id+'&redirect_uri='+oauthData.redirect_uri+'\">Agent <strong>login</strong></a>');\n        })\n        .catch(function(err) {\n            res.send(err + 'oops');\n            console.log(err + 'uhoh');\n            console.log('request failed', err)})\n}\n//https://searchidx.herokuapp.com/callback?openid.assoc_handle=%7BHMAC-SHA1%7D%7B58574516%7D%7B6I%2BC%2Bg%3D%3D%7D&openid.claimed_id=https%3A%2F%2Fsparkplatform.com%2Fopenid%2Fuserid%2Fmo.1524%3Fsession_id%3D6e338a49c2eef5f2d4e36270c0647de5&openid.identity=https%3A%2F%2Fsparkplatform.com%2Fopenid%2Fuserid%2Fmo.1524%3Fsession_id%3D6e338a49c2eef5f2d4e36270c0647de5&openid.mode=id_res&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0&openid.ns.spark=http%3A%2F%2Fsparkplatform.com%2Fextensions%2Fspark%2F1.0&openid.ns.sreg=http%3A%2F%2Fopenid.net%2Fextensions%2Fsreg%2F1.1&openid.op_endpoint=https%3A%2F%2Fsparkplatform.com%2Fopenid%3Fsession_id%3D6e338a49c2eef5f2d4e36270c0647de5&openid.response_nonce=2016-12-19T02%3A25%3A26ZV3Hhkt&openid.return_to=https%3A%2F%2Fsearchidx.herokuapp.com%2Fcallback&openid.sig=e582hxh5GzHutv0z%2FMIayGji6cw%3D&openid.signed=assoc_handle%2Cclaimed_id%2Cidentity%2Cmode%2Cns%2Cns.spark%2Cns.sreg%2Cop_endpoint%2Cresponse_nonce%2Creturn_to%2Csigned%2Cspark.code%2Csreg.fullname%2Csreg.nickname&openid.spark.code=6tbc7lcwmiedsbwrlnpokkrdb&openid.sreg.fullname=Paul+Amato&openid.sreg.nickname=20140811174925623895000000\nfunction oauthHeaders(){\n    return {\n        'X-SparkApi-User-Agent': 'DevApp',\n        'Authorization': 'OAuth '+oauthData.access_token,\n        'Content-Type': 'application/json'\n    };\n}\nfunction promiseSaveListings(listings){\n    function finishUpdate(uplst,ups,o,e,p) {\n        console.log('next - saving now')\n        e[p['idpath']] = uplst\n        e[p.zippath] = uplst\n        e[p.citypath] = uplst\n        e[p.streetpath] = uplst['Id']\n        e[p.streetnumpath] = uplst['Id']\n        //  console.log('updating!'+JSON.stringify(uplist))//\n        o.push(uplst)\n        ups = Object.assign(ups, e)\n        allupdates.push(updates);\n        return new Promise(function(resolve, reject) {\n            setTimeout(() => resolve(ups),25000 );})\n    }\n    function minipromise(prom){\n        return new Promise(function(resolve, reject) {\n            setTimeout(() => resolve(prom),25000 );})\n    }\n\n    let updates = {}\n    let obj = []\n    return new Promise(function(resolve, reject) {\n        setTimeout(() => resolve(listings), 2500 );})//2.5  seconds\n        .then(listings=>{\n            listings.forEach(listing=> {\n                let uplist = {media:{}}\n                uplist = Object.assign(uplist, listing.StandardFields);\n                uplist['Id'] = listing['Id'];\n                uplist['PhotoThumb'] = listing.StandardFields.Photos[0] ? listing.StandardFields.Photos[0].UriThumb : 'https://shire.mikeamato.org/wp-content/uploads/2016/11/shire110x75.png';\n                uplist['media']['PhotoThumb'] = listing.StandardFields.Photos[0] ? listing.StandardFields.Photos[0].UriThumb : 'https://shire.mikeamato.org/wp-content/uploads/2016/11/shire110x75.png';\n                uplist['PhotoLarge'] = listing.StandardFields.Photos[0].UriLarge ? listing.StandardFields.Photos[0].UriLarge : 'unset';\n                uplist['media']['PhotoLarge'] = listing.StandardFields.Photos[0].UriLarge ? listing.StandardFields.Photos[0].UriLarge : 'unset';\n                uplist['Photo800'] = listing.StandardFields.Photos[0].Uri800 ? listing.StandardFields.Photos[0].Uri800 : 'https://shire.mikeamato.org/wp-content/uploads/2016/11/shire110x75.png';\n                uplist['media']['Photo800'] = listing.StandardFields.Photos[0].Uri800 ? listing.StandardFields.Photos[0].Uri800 : 'https://shire.mikeamato.org/wp-content/uploads/2016/11/shire110x75.png';\n                uplist['Photo300'] = listing.StandardFields.Photos[0].Uri300 ? listing.StandardFields.Photos[0].Uri300 : 'unset';\n                uplist['media']['Photo300'] = listing.StandardFields.Photos[0].Uri300 ? listing.StandardFields.Photos[0].Uri300 : 'unset';\n                uplist['Photo1024'] = listing.StandardFields.Photos[0].Uri1024 ? listing.StandardFields.Photos[0].Uri1024 : 'https://shire.mikeamato.org/wp-content/uploads/2016/11/shire110x75.png';\n                uplist['media']['Photo1024'] = listing.StandardFields.Photos[0].Uri1024 ? listing.StandardFields.Photos[0].Uri1024 : 'https://shire.mikeamato.org/wp-content/uploads/2016/11/shire110x75.png';\n                uplist['PhotoId'] = listing.StandardFields.Photos[0].Id ? listing.StandardFields.Photos[0].Id : '0';\n                uplist['PhotoCaption'] = listing.StandardFields.Photos[0].Caption ? listing.StandardFields.Photos[0].Caption : 'Photo Caption';\n                let idpath = \"/listings/id/\" + listing['Id']\n                let entry = {}\n                let entrygeo = {}\n                let citypath = \"/listings/location/city/\" + uplist['City'] + \"/\" + listing['Id']\n                let zippath = \"/listings/location/zip/\" + uplist['PostalCode'] + \"/\" + listing['Id'];\n                let streetpath = \"/listings/location/street/name/\" + encode(uplist['StreetName']) + \"/\" + listing['Id']\n                let streetnumpath = \"/listings/location/street/number/\" + encode(uplist['StreetNumber']) + \"/\" + listing['Id']\n                let paths = {idpath:idpath,citypath:citypath,zippath:zippath,streetpath:streetpath,streetnumpath:streetnumpath}\n\n                // size({url: uplist['PhotoLarge']},function (err, dimensions, length) {\n                //     console.log(JSON.stringify(dimensions))\n                //     uplist['PhotoLargeH'] = dimensions.height;\n                //     uplist['PhotoLargeW'] = dimensions.width;\n                //     finishUpdate(uplist,updates,obj,entry,paths);\n                // })\n\n                let saving = {};\n                if (uplist['Photos'][0]){\n                    let saving = Object.keys(uplist['media']).forEach(key=>{\n                            size({url: uplist['media'][key]},function (err, dimensions, length) {\n                                console.log(JSON.stringify(dimensions))\n                                uplist['media'][key]\n                                uplist['media'][key+'_size'] = dimensions;\n                                uplist['media'][key+'_width'] = dimensions.width;\n                                finishUpdate(uplist,updates,obj,entry,paths);\n                            }).then(g=>{console.log(JSON.stringify(g))\n                            }).catch(e=>{console.log('while sizing got error :'+e)})})}\n                minipromise(saving)\n                    .then(enddata=>{\n                        finishUpdate(uplist,updates,obj,entry,paths);\n                    })\n                    .catch((err) => console.log(\"error: \"+JSON.stringify(err)));\n            })\n\n            console.log('# of listings: '+listings.length);\n        })\n        .then(end=>{\n            return end;\n        })\n        .catch((err) => console.log(\"error: \"+\" \"+JSON.stringify(listings), err.message));\n}\nfunction removeall(){\n    let remit = dB.ref('/listings').remove().then(function () {\n        return \"done clearing\";\n    })}\nfunction getPage(ops){\n    console.log('getting with ops:'+JSON.stringify(ops))\n    return new Promise(function(resolve, reject) {\n        setTimeout(() => resolve(ops), 250000 );})//250  seconds\n        .catch((err) => console.log(\"error: \"+JSON.stringify(ops), err));\n}\nfunction getListings(req,res, filter,addr) {\n    let combo=[];\n    let obj = []\n    let pageops=[];\n    let setargs = {\n        _filter: filter\n    };\n    let opsurl =  makeUrl(setargs, null, 'A', 'https://sparkapi.com/v1/listings?', 'Active');\n    let authops = {\n        headers: oauthHeaders(),\n        uri: opsurl+'&_pagination=count&_page=1',\n        json: true\n    };\n    console.log('about to request...'+JSON.stringify(authops))\n    rp(authops)\n        .then(pb => {\n            // results.concat(pb['D']['Results']);\n            console.log('pagei:'+JSON.stringify(pb['D']['Pagination']))\n\n            let pages = pb['D']['Pagination']['TotalPages'];\n            let currentpage = pb['D']['Pagination']['CurrentPage'];\n            let pagearr=[]\n            if (currentpage < pages){\n\n                for (let page = 1; page < pages; page++) {\n                    let pageReq = {};\n                    let newops = {headers:oauthHeaders(),uri:opsurl+'&_pagination=1&_page='+page,json:true};\n                    pagearr.push(newops)\n\n                }}else\n            {\n                let newops = {headers:oauthHeaders(),uri:opsurl+'&_pagination=1&_page=1',json:true};\n                pagearr.push(newops)\n            }\n            let promisedPages=pagearr.map(ops=>{\n                return getPage(rp(ops).then(pb=>{\n                    console.log('adding to combo'+pb['D']['Pagination']['CurrentPage'])\n                    promiseSaveListings(pb['D']['Results'])}));\n            })\n            Promise.all(promisedPages)\n                .then(endres=>{\n                    // res.set({'Access-Control-Allow-Origin':'*'});\n                    console.log('saving combo with '+combo.length)\n\n                    console.log('length:'+combo.length);\n                    // res.send(combo)\n                    // dB.ref('/').update(ups);\n\n                })\n                .then(endres=>{\n                dB.ref('/').update(allupdates);\n\n            });\n            ;\n        })\n        .catch(errors.StatusCodeError, function (reason) {\n            // The server responded with a status codes other than 2xx.\n            // Check\n            if (reason.statusCode == 401) {\n                console.log(reason)\n                refreshAuth(oauthData)\n            }\n        })\n        // .catch(this.checkStatus)\n        .catch(errors.RequestError, function (reason) {\n            // reason.cause is the Error object Request would pass into a callback.\n            console.log(reason.cause)\n        })\n        .catch(e=>{\n            // reason.cause is the Error object Request would pass into a callback.\n            console.log('e:'+e)\n        })\n    console.log('going!')\n\n}\n\nfunction makeUrl(args,zipcode=null,proptype=null,base='https://sparkapi.com/v1/listings?',status=null){\n    let argfilter = args['_filter']?args['_filter']:''\n    let select = 'StreetNumber,StreetName,PostalCode,ListPrice,City,BedsTotal,BathsTotal,PublicRemarks,PropertyType,MlsStatus,Photos,Latitude,ListingId,Longitude,PostalCode,PropertySubType,YearBuilt'\n    let andT = args['_filter']?' And ':''\n    let zipfilter = zipcode?argfilter+andT+`\" PostalCode Eq '${zipcode}'`:argfilter\n    let andZ = zipcode?andT:''\n    let proptypefilter = proptype?zipfilter+andZ+\" PropertyType Eq '\"+proptype+\"'\":zipfilter\n    let andP = zipcode?andT:''\n    let statusFilter = status?proptypefilter+andP+\" MlsStatus Eq '\"+status+\"'\":proptypefilter\n    // let limit = args['_select']?25:25\n    let formatargs = {\n        // _pagination:'1',\n        _orderby:   'City',\n        _filter:    args['_filter'],\n        _limit:     50,\n        // _page:      1,\n        _select:    'Photos.UriThumb,Photos.UriLarge,Photos.Uri300,Photos.Caption,PrimaryPhoto,StreetNumber,StreetName,StreetSuffix,PostalCode,ListPrice,City,BedsTotal,BathsTotal,PublicRemarks,PropertyType,MlsStatus,Latitude,ListingId,Longitude,PostalCode,PropertySubType,YearBuilt',\n    }\n    // formatargs['_page'] = args['_page']?args['_page']:1\n    // formatargs['_select'] = select\n    args = Object.assign({},formatargs)\n    let arr = Object.keys(args).map(key=>{\n        let argEntry = formatargs[key]?formatargs[key]:args[key]\n        let entry = key+\"=\"+argEntry\n        return entry\n    })\n    return base+arr.join('&')\n}\nfunction promiseTo(doThis) {\n    console.log('promised to do something ...')\n    return new Promise(function(resolve, reject) {\n        setTimeout(() => resolve(doThis), 1*doThis);})\n}\nfunction refreshAuth(oa) {\n    let headers = {\n        'X-SparkApi-User-Agent': 'IDX Agent',\n        'Content-Type': 'application/json'\n    };\n    let rauth = {\n        url:'https://sparkapi.com/v1/oauth2/grant',\n        method:'POST',\n        headers: headers,\n        body: oa,\n        json: true\n    };\n\n    rauth.body['grant_type']=\"refresh_token\";\n    console.log('refreshing with :'+JSON.stringify(rauth))\n\n        rp(rauth, function (err, res, body) {\n    }).then(pb=>{        saveOauthData(pb);\n    })\n        .catch(errors.StatusCodeError, function (reason) {\n            console.log('Reason:'+reason+'          #####################   Status Code : '+reason.statusCode)})\n        .catch(errors.RequestError, function (reason) {console.log(reason)})\n\n}\napp.get('/remove', function (req, res) {\n    removeall();\n    res.send('cleared ')\n})\napp.get('/addr/:addr', function (req, res) {\n    let addr = req.params.addr;\n\n    let thefilter = \"PropertyType Eq 'A' And MlsStatus Eq 'Active' And (City Eq '\"+addr+\"' Or StreetAddress Eq '\"+addr+\"')\"\n    console.log(thefilter);\n    getListings(req,res,thefilter,addr)\n})\napp.get('/callback', function (req, res) {\n    handleCallback(req,res);\n})\n\napp.get('/auth', (req, res) => {\n    var uri = \"https://sparkplatform.com/openid?openid.mode=checkid_setup&openid.return_to=\"+oauthData.redirect_uri+\"&openid.spark.client_id=\"+oauthData.client_id+\"&openid.spark.combined_flow=true\";\n    res.location(uri);\n    res.send('<a href=\"https://sparkplatform.com/openid?openid.mode=checkid_setup&openid.return_to='+oauthData.redirect_uri+'&openid.spark.client_id='+oauthData.client_id+'&openid.spark.combined_flow=true\">auth</a>')\n\n});\n\n"]}